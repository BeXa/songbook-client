#!/bin/bash

#Author: M. Bussonnier
#Date: 15/04/2011
#Descritpion: This script looks for *.cc and *.hh files in SRC_DIRECTORY and checks their licenses

if [ $# -ne 1 ];
then
    echo "Usage: $0 SRC_DIRECTORY"
    echo "Description: check licenses for *.cc and *.hh in SRC_DIRECTORY"
    exit 1
fi;

BASEDIR=`dirname $0` 

VERT="\\033[0;32m"
JAUNE="\\033[1;33m"
NORMAL="\\033[0;39m"
ROUGE="\\033[1;31m"
ROSE="\\033[1;35m"
BLEU="\\033[1;34m"
BLANC="\\033[0;02m"
BLANCLAIR="\\033[1;08m"
JAUNE="\\033[1;33m"
CYAN="\\033[1;36m"

LICFILE="$BASEDIR/lic.txt"
NL=$(cat $LICFILE |wc -l)
function includefile {
 return  $(diff $1 $2 |grep '^>' | wc -l)
}
function checklicence {
	if $(includefile $1 $BASEDIR/headcopyright.txt)
	then
		echo -en $VERT  'copyright...ok'
	else
		echo -en $ROUGE 'bad copyright?'
	fi

		echo -en '\t|\t'

	if $(includefile $1  $BASEDIR/lic.txt)
	then
		echo -e "$VERT" "ok \t: $1"
		return 0
	fi


	if $(includefile $1 $BASEDIR/nokia.txt)
	then
		echo -en "$BLEU" "nokia"
		echo -e "$VERT" "\t: $1"
		return 0
	fi

	if $(includefile $1 $BASEDIR/bsd.txt)
	then
		echo -en "$ROSE" "bsd"
		echo -e "$VERT" "\t: $1"
		return 0
	fi

	echo -e "$ROUGE" "fail\t: $1"
	return 1
}

rvalue=0
self=$0
cc=$(find $1 -name '*.cc' -type f )
hh=$(find $1 -name '*.hh' -type f )

for i in $self $cc $hh ; do
	if !(checklicence $i)
	then
		rvalue=$(expr $rvalue + 1)
	fi
done

if [[ $rvalue != 0 ]]
then
	echo -e $ROUGE "********************************************"
	echo -e $ROUGE "* Some files are not properly licenced *"
	echo -e $ROUGE "********************************************"
	echo -e $BLEU  "** $rvalue file(s) need to be manually checked **"
else
	echo -e $VERT "********************************************"
	echo -e $VERT "*         Everything seems alright       *"
	echo -e $VERT "********************************************"
fi
exit $rvalue
